{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Riyadh Al Bilad Transport for KSA{% endblock %}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;600;700&display=swap');
        body { font-family: 'Space Grotesk', sans-serif; scroll-behavior: smooth; }
        .glass-effect { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); }
        .chat-widget { transition: all 0.25s ease-in-out; }
        .chat-hidden { transform: translateY(16px) scale(0.98); opacity: 0; pointer-events: none; }
        .vehicle-gallery-stage { aspect-ratio: 4 / 3; touch-action: pan-y; }
        .vehicle-gallery-main-button { aspect-ratio: 4 / 3; }
        .vehicle-gallery-modal { position: fixed; inset: 0; z-index: 70; background: rgba(2, 6, 23, 0.92); display: flex; align-items: center; justify-content: center; padding: 1rem; }
        .vehicle-gallery-modal-stage { aspect-ratio: 16 / 10; max-height: 84vh; touch-action: pan-y; }
        .vehicle-gallery-image { transition: opacity 0.22s ease, transform 0.22s ease; }
        .vehicle-gallery-image.is-loading { opacity: 0.4; transform: scale(1.01); }
        .vehicle-gallery-thumbs { scroll-behavior: smooth; -webkit-overflow-scrolling: touch; scrollbar-width: thin; scrollbar-color: #9ca3af transparent; }
        .vehicle-gallery-thumbs::-webkit-scrollbar { height: 7px; }
        .vehicle-gallery-thumbs::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 99px; }
        .vehicle-gallery-thumbs::-webkit-scrollbar-track { background: transparent; }
        .vehicle-gallery-thumb { width: 96px; min-width: 96px; aspect-ratio: 4 / 3; border: 2px solid transparent; border-radius: 0.75rem; overflow: hidden; opacity: 0.72; transition: border-color 0.2s ease, opacity 0.2s ease, transform 0.2s ease; }
        .vehicle-gallery-thumb:hover,
        .vehicle-gallery-thumb:focus-visible { opacity: 1; transform: translateY(-1px); }
        .vehicle-gallery-thumb.is-active { border-color: #15803d; opacity: 1; }
        @media (max-width: 640px) {
            .vehicle-gallery-stage,
            .vehicle-gallery-main-button { aspect-ratio: 1 / 1; }
            .vehicle-gallery-thumb { width: 82px; min-width: 82px; }
            .vehicle-gallery-nav { width: 2.25rem; height: 2.25rem; }
            .vehicle-gallery-modal-stage { width: 100%; aspect-ratio: 4 / 3; }
        }
    </style>
    {% block extra_head %}{% endblock %}
</head>
<body class="bg-gray-50 text-gray-900">

    <!-- Navigation -->
    <nav class="sticky top-0 z-40 glass-effect border-b border-gray-200 py-4 px-6 flex justify-between items-center">
        <a href="{% url 'core:home' %}" class="text-2xl font-bold text-green-700" title="Riyadh Al Bilad Transport for KSA">RBT <span class="text-gray-700">KSA</span></a>
        <div class="flex items-center gap-6">
            <a href="{% url 'core:home' %}" class="text-gray-600 hover:text-green-700 font-medium">Home</a>
            <a href="{% url 'sales:vehicle_list' %}" class="text-gray-600 hover:text-green-700 font-medium">Vehicles for Sale</a>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto px-4 py-8 min-h-screen">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 py-12 mt-12">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-gray-500">&copy; 2026 Riyadh Al Bilad Transport for KSA. All rights reserved.</p>
            <a href="https://rashidzada.pythonanywhere.com/" target="_blank" rel="noopener noreferrer" class="inline-block mt-2 text-sm text-gray-500 hover:text-green-700">
                Developed by Rashid Zada
            </a>
        </div>
    </footer>

    <!-- Floating Actions -->
    {% if site_settings.support_whatsapp_number %}
    <a href="https://wa.me/{{ site_settings.support_whatsapp_number }}?text={{ 'Hello, I need support for a booking.'|urlencode }}" target="_blank" rel="noopener noreferrer" class="fixed bottom-6 right-6 z-50 bg-green-500 text-white px-5 py-3 rounded-full shadow-2xl hover:scale-105 transition-transform flex items-center gap-2">
        <i class="fab fa-whatsapp text-xl"></i>
        <span class="font-bold">Support</span>
    </a>
    {% endif %}

    <button id="chat-toggle" aria-label="Open chat" class="fixed bottom-20 right-4 sm:right-6 z-50 bg-green-700 text-white px-4 py-2 rounded-full shadow-xl hover:bg-green-800 transition-colors flex items-center gap-2 text-sm">
        <i class="fas fa-comment-dots text-xl"></i>
        <span class="font-bold">Chat</span>
    </button>

    <!-- Chatbot Widget -->
    <div id="chat-window" class="chat-widget chat-hidden fixed bottom-28 right-4 sm:right-6 z-50 w-[92vw] sm:w-80 md:w-96 bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-hidden flex flex-col h-[60vh] sm:h-[420px] md:h-[460px] max-h-[70vh]">
        <div class="bg-green-700 p-4 text-white flex justify-between items-center">
            <h3 class="font-bold">RBT KSA Assistant</h3>
            <button id="chat-close" aria-label="Close chat" class="text-white hover:text-gray-100 text-lg">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div id="chat-messages" class="flex-1 p-4 overflow-y-auto space-y-4 text-sm">
            <div class="bg-gray-100 p-3 rounded-lg mr-8">
                <strong>Welcome to RBT KSA!</strong><br>
                Are you looking to book transport or buy a vehicle?
            </div>
        </div>
        
        <div class="p-4 border-t border-gray-100 flex gap-2">
            <input type="text" id="chat-input" placeholder="Type your message..." class="flex-1 border border-gray-200 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-green-700">
            <button id="chat-send" aria-label="Send message" class="bg-green-700 text-white px-4 py-2 rounded-lg hover:bg-green-800 transition-colors">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>

    <script>
        const chatToggle = document.getElementById('chat-toggle');
        const chatClose = document.getElementById('chat-close');
        const chatWindow = document.getElementById('chat-window');
        const chatInput = document.getElementById('chat-input');
        const chatSend = document.getElementById('chat-send');
        const chatMessages = document.getElementById('chat-messages');

        chatToggle.onclick = () => chatWindow.classList.toggle('chat-hidden');
        chatClose.onclick = () => chatWindow.classList.add('chat-hidden');

        function getCookie(name) {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith(name + '='));
            return cookieValue ? decodeURIComponent(cookieValue.split('=')[1]) : '';
        }

        async function sendMessage() {
            const message = chatInput.value.trim();
            if (!message) return;

            // Add user message to UI
            addMessage(message, 'user');
            chatInput.value = '';

            try {
                const response = await fetch('/api/chat/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({ message: message, context: { path: window.location.pathname } })
                });
                const data = await response.json();
                addMessage(data.reply, 'bot');
            } catch (error) {
                console.error('Error:', error);
                addMessage('Sorry, something went wrong. Please try again.', 'bot');
            }
        }

        function escapeHtml(value) {
            return String(value || '').replace(/[&<>"']/g, (match) => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#39;'
            }[match]));
        }

        function decodeHtmlEntities(value) {
            const textarea = document.createElement('textarea');
            textarea.innerHTML = String(value || '');
            return textarea.value;
        }

        function formatBotMessage(text) {
            const normalized = decodeHtmlEntities(text).replace(/\r\n/g, '\n');
            const escaped = escapeHtml(normalized);
            const withoutHeadingMarks = escaped.replace(/^#{1,6}\s*/gm, '');
            const withBold = withoutHeadingMarks.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
            return withBold.replace(/\n/g, '<br>');
        }

        function addMessage(text, sender) {
            const div = document.createElement('div');
            div.className = sender === 'user' 
                ? 'bg-green-100 p-3 rounded-lg ml-8 text-right' 
                : 'bg-gray-100 p-3 rounded-lg mr-8';
            if (sender === 'user') {
                div.innerText = text;
            } else {
                div.innerHTML = formatBotMessage(text);
            }
            chatMessages.appendChild(div);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }

        chatSend.onclick = sendMessage;
        chatInput.onkeypress = (e) => { if (e.key === 'Enter') sendMessage(); };
    </script>
    <script src="{% static 'js/vehicle-gallery.js' %}"></script>
    {% block extra_js %}{% endblock %}
</body>
</html>
